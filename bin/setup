#!/usr/bin/env bash
set -e

VERBOSE=false
CLEAN=false

for arg in "$@"; do
  if [[ "$arg" == "--verbose" ]]; then
    VERBOSE=true
  fi
done

for arg in "$@"; do
  if [[ "$arg" == "--verbose" ]]; then
    VERBOSE=true
  elif [[ "$arg" == "--clean" ]]; then
    CLEAN=true
  fi
done

run() {
  if $VERBOSE; then
    echo "+ $*"
    "$@"
  else
    "$@" > /dev/null 2>&1
  fi
}

if $CLEAN; then
  echo "== ğŸ§¹ Cleaning Docker containers, volumes, and images =="
  run docker compose down --volumes --remove-orphans
  run docker image prune -f
fi


echo "== ğŸš€ Building Docker images =="
run docker compose build 

echo "== ğŸ³ Starting containers in detached mode =="
run docker compose up -d

echo "== ğŸ—„ï¸ Setting up database (create + migrate) =="
run docker compose exec web bin/rails db:prepare

echo "== âœ… Rails running at http://localhost:3000"
echo "== âœ… React running at http://localhost:5173"